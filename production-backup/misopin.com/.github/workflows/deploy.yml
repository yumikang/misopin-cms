name: Deploy to Production

# ğŸ¯ ë°°í¬ ì „ëµ:
# ê°œë°œ ì¤‘: auto_deploy = true â†’ ìë™ ë°°í¬
# ìš´ì˜ ì¤‘: auto_deploy = false â†’ CMS ì „ìš©

env:
  AUTO_DEPLOY: true  # falseë¡œ ë³€ê²½í•˜ë©´ ìë™ ë°°í¬ ì¤‘ë‹¨

on:
  push:
    branches:
      - master
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ ê°€ëŠ¥
    inputs:
      reason:
        description: 'ë°°í¬ ì‚¬ìœ  (ì„ íƒ)'
        required: false

jobs:
  deploy:
    name: Deploy Static Site
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Show deployment info
        run: |
          echo "ğŸš€ Deploying to production server..."
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"

      - name: ğŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“‹ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 141.164.60.51 >> ~/.ssh/known_hosts

      - name: ğŸ§ª Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no root@141.164.60.51 "echo 'âœ… SSH connection successful'"

      - name: ğŸ“¤ Deploy files to server
        run: |
          echo "ğŸ”„ Syncing files to server..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            ./ root@141.164.60.51:/var/www/misopin.com/

      - name: ğŸ”§ Set correct permissions
        run: |
          ssh root@141.164.60.51 "
            echo 'ğŸ” Setting file permissions...'
            chown -R root:caddy /var/www/misopin.com
            find /var/www/misopin.com -type d -exec chmod 755 {} \;
            find /var/www/misopin.com -type f -name '*.html' -exec chmod 664 {} \;
            find /var/www/misopin.com -type f ! -name '*.html' -exec chmod 644 {} \;
            echo 'âœ… Permissions updated'
          "

      - name: ğŸ“Š Verify deployment
        run: |
          ssh root@141.164.60.51 "
            echo 'ğŸ“ˆ Deployment verification...'
            echo 'ğŸ“ Files deployed:'
            find /var/www/misopin.com -name '*.html' | wc -l
            echo 'ğŸ’¾ Disk usage:'
            du -sh /var/www/misopin.com
            echo 'ğŸ‘¤ Ownership:'
            ls -ld /var/www/misopin.com | awk '{print \$3\":\"\$4}'
          "

      - name: ğŸŒ Test site availability
        run: |
          echo "ğŸ” Testing site..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://misopin.one-q.xyz/)
          if [ "$response" = "200" ]; then
            echo "âœ… Site is live and responding with HTTP 200"
          else
            echo "âš ï¸ Site responded with HTTP $response"
            exit 1
          fi

      - name: ğŸ’¾ Create backup
        run: |
          ssh root@141.164.60.51 "/usr/local/bin/backup-misopin.sh"
          echo "âœ… Backup created"

      - name: ğŸ‰ Deployment complete
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Live site: http://misopin.one-q.xyz"
          echo "ğŸ“… Deployed at: $(date)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
