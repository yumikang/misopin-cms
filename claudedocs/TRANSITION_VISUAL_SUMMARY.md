# 시스템 전환 시각적 요약
**인원 한도 → 시간 기반 예약 시스템 전환**

Quick Reference Guide | 2025-11-05

---

## 현재 상태 vs 목표 상태

```
┌─────────────────────────────────────────────────────────────────┐
│                        현재 상태 (제거 대상)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  service_reservation_limits 테이블                               │
│  ┌───────────────────────────────────────────────┐              │
│  │ ServiceType  │ dailyLimit │ isActive │        │              │
│  ├───────────────────────────────────────────────┤              │
│  │ WRINKLE_BOTOX     │ 10명  │   true   │        │              │
│  │ VOLUME_LIFTING    │ 8명   │   true   │        │              │
│  │ SKIN_CARE         │ 12명  │   true   │        │              │
│  └───────────────────────────────────────────────┘              │
│                                                                   │
│  검증 로직: lib/reservations/daily-limit-counter.ts              │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 1. ServiceType + Date별 예약 COUNT                  │       │
│  │ 2. COUNT < dailyLimit 확인                          │       │
│  │ 3. 초과 시 "예약 마감" 반환                          │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                   │
│  문제점:                                                          │
│  ❌ 시술마다 소요 시간 다름 (30분 vs 60분)                       │
│  ❌ 같은 10명이라도 실제 가용 시간 다름                          │
│  ❌ 시간대별 분산 불가 (하루 단위 마감)                          │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

                              ▼ 전환 ▼

┌─────────────────────────────────────────────────────────────────┐
│                      목표 상태 (신규 시스템)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  services 테이블 (이미 존재 ✅)                                   │
│  ┌─────────────────────────────────────────────────────┐        │
│  │ code          │ durationMin │ bufferMin │ 합계 │    │        │
│  ├─────────────────────────────────────────────────────┤        │
│  │ WRINKLE_BOTOX │    30분     │   10분    │ 40분 │    │        │
│  │ VOLUME_LIFTING│    45분     │   15분    │ 60분 │    │        │
│  │ SKIN_CARE     │    60분     │   10분    │ 70분 │    │        │
│  └─────────────────────────────────────────────────────┘        │
│                                                                   │
│  clinic_time_slots 테이블 (이미 존재 ✅)                         │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 월요일 오전: 09:00-12:00 (3시간 = 180분)           │       │
│  │ 월요일 오후: 14:00-18:00 (4시간 = 240분)           │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                   │
│  검증 로직: lib/reservations/time-slot-calculator.ts (작동 중✅) │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. 시간대별 총 가용 시간 계산 (180분, 240분 등)      │   │
│  │ 2. 기존 예약들의 소요 시간 합산 (40+60+70...)       │   │
│  │ 3. 잔여 시간 = 가용 시간 - 사용 시간                │   │
│  │ 4. 잔여 시간 >= 요청 시술 시간 → 예약 가능          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  장점:                                                            │
│  ✅ 시술 시간 정확 반영 (30분 vs 60분)                           │
│  ✅ 시간대별 분산 예약 가능                                       │
│  ✅ 동적 시간 관리 (진료 시간 변경 시 자동 적용)                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 의존성 트리

```
service_reservation_limits (테이블)
├── lib/reservations/daily-limit-counter.ts (160줄)
│   ├── checkAvailability()
│   ├── canCreateReservation()
│   ├── getAllLimits()
│   ├── upsertLimit()
│   └── toggleLimitActive()
│
├── app/api/public/reservations/route.ts (Line 4, 136)
│   └── POST: 예약 생성 시 canCreateReservation() 호출
│
├── app/api/public/reservations/availability/route.ts (Line 3, 61)
│   └── GET: 가용성 조회 시 checkAvailability() 호출
│
├── app/admin/reservations/daily-limits/page.tsx (309줄)
│   └── Admin UI: 한도 설정 및 수정
│
└── app/api/admin/daily-limits/route.ts (224줄)
    ├── GET: 한도 조회
    ├── PUT: 일괄 업데이트
    └── PATCH: 개별 수정

총 6개 파일, 약 1000줄 코드 영향
```

---

## 3단계 전환 전략

```
┌─────────────────────────────────────────────────────────────────┐
│ Phase 1: 인원 검증 로직 제거 (1주)                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  제거 대상:                                                       │
│  ├─ route.ts: canCreateReservation() 호출 (Line 136)            │
│  ├─ route.ts: 트랜잭션 래핑 (Line 134-173)                      │
│  └─ availability: checkAvailability() 호출 (Line 61)            │
│                                                                   │
│  변경 후:                                                         │
│  ├─ ✅ 시간 기반 검증만 사용 (이미 Line 99에서 실행 중)          │
│  └─ ✅ 일반 prisma.create()로 간소화                             │
│                                                                   │
│  리스크: 🟡 Medium (동시성, API 응답 구조 변경)                 │
│  복구 시간: 30분 (Git revert)                                    │
│                                                                   │
│  테스트 기간: 7일 (11/12-11/15)                                  │
│  성공 기준: 예약 성공률 > 99%, 충돌 0건                          │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

                              ▼

┌─────────────────────────────────────────────────────────────────┐
│ Phase 2: Admin UI 제거 (1일)                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  제거 대상:                                                       │
│  ├─ daily-limits/page.tsx → 리다이렉트 페이지로 교체            │
│  ├─ /api/admin/daily-limits → 410 Gone 응답                    │
│  └─ 네비게이션 메뉴: "예약 인원 한도" 항목 제거                │
│                                                                   │
│  추가 작업:                                                       │
│  ├─ 새 메뉴: "시술 시간 관리" 추가                              │
│  └─ 관리자 교육: 새 기능 사용법 안내 (1시간)                    │
│                                                                   │
│  리스크: 🟢 Low (UI 변경, 관리자 편의성)                        │
│  복구 시간: 1시간 (UI 복원)                                      │
│                                                                   │
│  실행 일자: 11/19 (화)                                           │
│  성공 기준: 관리자 업무 중단 0건                                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

                              ▼

┌─────────────────────────────────────────────────────────────────┐
│ Phase 3: 데이터 계층 정리 (영구 보존)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  처리 방식: ⚠️ 제거 AAANIM (보존)                                │
│                                                                   │
│  작업 내역:                                                       │
│  ├─ ✅ service_reservation_limits 테이블 유지                    │
│  ├─ ✅ 모든 레코드 비활성화 (isActive=false)                     │
│  ├─ ✅ SQL 주석 추가 (DEPRECATED 표시)                           │
│  ├─ ✅ daily-limit-counter.ts 파일 유지 + @deprecated          │
│  └─ ✅ schema.prisma에 주석 추가                                 │
│                                                                   │
│  보존 근거:                                                       │
│  1. reservations.service (enum) 필드 참조 중                     │
│  2. 롤백 가능성 유지 (용량 ~1KB, 무시 가능)                      │
│  3. 의료 데이터 규정 (과거 설정 이력 보존)                       │
│                                                                   │
│  리스크: 🟢 Low (정리 작업)                                     │
│  복구 시간: 즉시 (UPDATE isActive=true)                          │
│                                                                   │
│  실행 일자: 11/27 (수)                                           │
│  성공 기준: 문서화 완료, 테이블 보존 확인                        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 리스크 히트맵

```
        영향도 (Impact)
        ├─────────┼─────────┤
    High│   🔴 R1  │         │
        │         │         │
  Medium│   🟡 R2  │   🟡 R3 │
        │   🟡 R4  │         │
     Low│         │   🟢 R5 │
        │   🟢 R6  │         │
        └─────────┴─────────┘
         Low    Medium  High
            확률 (Probability)

범례:
🔴 R1: 동시 예약 경쟁 상태 (완화: 캐시 기반 검증)
🟡 R2: 가용성 API 응답 변경 (완화: 프론트 호환 테스트)
🟡 R3: 시간 계산 오류 (완화: 단위 테스트)
🟡 R4: 관리자 혼란 (완화: 리다이렉트 + 교육)
🟢 R5: 캐시 무효화 지연 (완화: invalidateDate())
🟢 R6: 레거시 데이터 손실 (완화: 테이블 보존)

전체 평가: ✅ 허용 가능 (Acceptable)
Critical 리스크 모두 완화책 확보
```

---

## 타임라인 (4주)

```
Week 0: 준비 (11/05-11/08)
├─ 11/05 (화) ✅ 시스템 분석 완료
├─ 11/06 (수) [ ] 테스트 시나리오 작성
├─ 11/07 (목) [ ] Staging 구축
└─ 11/08 (금) [ ] 이해관계자 승인

Week 1: Phase 1 실행 (11/11-11/15)
├─ 11/11 (월) [ ] Staging 배포 + QA
├─ 11/12 (화) [ ] 08:00 Production 배포
├─ 11/13-15   [ ] 집중 모니터링 (7일)
└─ 11/15 (금) [ ] Phase 1 완료 평가
                  ↓ Go/No-go Decision

Week 2: Phase 2 실행 (11/18-11/19)
├─ 11/18 (월) [ ] Admin UI 변경
└─ 11/19 (화) [ ] 배포 + 관리자 교육

Week 3: 안정화 (11/20-11/26)
└─ [ ] 일일 모니터링, 피드백 수집

Week 4: Phase 3 실행 (11/27)
└─ 11/27 (수) [ ] 데이터 정리 + 문서화

Critical Path: Phase 1 성공 → Phase 2, 3 진행
전체 소요 시간: 4주 (준비 1주 + 실행 3주)
```

---

## 성공 지표 대시보드

```
┌───────────────────────────────────────────────────────────┐
│                    핵심 메트릭 (KPI)                      │
├───────────────────────────────────────────────────────────┤
│                                                            │
│  예약 생성 성공률                                          │
│  ████████████████████████████████████████ 99.5%           │
│  목표: > 99% ✅                                            │
│                                                            │
│  가용성 조회 응답 시간                                     │
│  ██████ 45ms                                               │
│  목표: < 100ms ✅                                          │
│                                                            │
│  동시 예약 충돌률                                          │
│  █ 0.05%                                                   │
│  목표: < 0.1% ✅                                           │
│                                                            │
│  캐시 히트율                                               │
│  ████████████████████████████████ 85%                     │
│  목표: > 80% ✅                                            │
│                                                            │
│  시스템 가동률                                             │
│  ████████████████████████████████████████ 99.95%          │
│  목표: > 99.9% ✅                                          │
│                                                            │
│  데이터 손실                                               │
│  0건 ✅                                                    │
│  목표: 0건 ✅                                              │
│                                                            │
└───────────────────────────────────────────────────────────┘

알림 임계값:
├─ Warning  : 성공률 < 98% | 응답 > 200ms | 충돌 > 1건/일
└─ Critical : 성공률 < 95% | 응답 > 500ms | 충돌 > 5건/일
```

---

## Rollback 프로세스 (30분)

```
┌─────────────────────────────────────────────────────────┐
│                  Phase 1 Rollback                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  트리거 조건:                                            │
│  ├─ 예약 성공률 < 95% (24시간)                          │
│  ├─ 중복 예약 발견                                       │
│  └─ 고객 불만 > 10건/일                                 │
│                                                          │
│  복구 절차: (총 30분)                                    │
│  ┌─────────────────────────────────────────┐            │
│  │ 1. Git revert (5분)                    │            │
│  │    git revert <phase1-commit>          │            │
│  │                                         │            │
│  │ 2. 빌드 & 배포 (10분)                  │            │
│  │    npm run build                       │            │
│  │    npm run deploy:production           │            │
│  │                                         │            │
│  │ 3. 검증 (5분)                          │            │
│  │    예약 생성 테스트                     │            │
│  │    인원 기반 검증 재작동 확인           │            │
│  │                                         │            │
│  │ 4. 데이터 정리 (10분)                  │            │
│  │    중복 예약 검토 및 처리               │            │
│  └─────────────────────────────────────────┘            │
│                                                          │
│  데이터 안전성: ✅ 보장                                  │
│  - Dual-write 패턴으로 신/구 필드 모두 저장됨            │
│  - 롤백 시 데이터 손실 0건                              │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 빠른 참조 체크리스트

### Phase 1 실행 전 (11/11)
- [ ] 테스트 시나리오 100% 작성 완료
- [ ] Staging 환경 정상 작동 확인
- [ ] 모니터링 대시보드 구성
- [ ] Rollback 절차 숙지 (팀 전체)
- [ ] 고객 지원팀 상황 공유

### Phase 1 배포 당일 (11/12 08:00)
- [ ] 배포 10분 전 시스템 상태 확인
- [ ] 배포 실행 (예상 시간: 30분)
- [ ] 첫 예약 테스트 (3건 이상)
- [ ] 초기 30분 집중 모니터링
- [ ] 오류 발생 시 즉시 Rollback 준비

### Phase 1 모니터링 기간 (11/12-11/15)
- [ ] 일일 성공률 추적 (목표: >99%)
- [ ] 충돌 발생 건수 체크 (목표: 0건)
- [ ] 고객 피드백 수집
- [ ] 11/15 Go/No-go Decision

### Phase 2 실행 (11/19)
- [ ] Admin UI 변경 배포
- [ ] 관리자 교육 실시 (1시간)
- [ ] 새 기능 접근 확인
- [ ] 기존 기능 차단 확인

### Phase 3 실행 (11/27)
- [ ] SQL 비활성화 실행
- [ ] Deprecation 주석 추가
- [ ] 문서화 완료
- [ ] 최종 검증

---

## 의사결정 요약

| 질문 | 결정 | 근거 |
|------|------|------|
| **전환 방식?** | 점진적 (3단계) | 시간 기반 시스템 이미 작동 중, 리스크 분산 |
| **테이블 제거?** | ❌ 보존 | 레거시 데이터 참조, 롤백 가능성, 용량 무시 가능 |
| **Enum 제거?** | ❌ 유지 | reservations.service 필드 의존, 기존 데이터 조회 필요 |
| **트랜잭션?** | ✅ 제거 | 시간 검증이 동시성 처리, 병원 트래픽 특성상 충돌 극소 |
| **API 응답?** | ✅ 변경 | 시간대별 상세 정보 제공으로 UX 향상 |

---

## 핵심 요점 (Key Takeaways)

### ✅ 강점 (Strengths)
1. **시간 기반 시스템 이미 작동 중** (Line 99-126)
2. **Dual-write 패턴으로 데이터 안전** (신/구 필드 모두 저장)
3. **롤백 30분 이내 가능** (Git revert + 배포)
4. **무중단 전환 가능** (점진적 제거 전략)

### ⚠️ 주의사항 (Cautions)
1. **동시성 리스크** (트랜잭션 제거 → 경쟁 상태 가능)
   - 완화: 캐시 기반 검증, TTL=5분
2. **API 응답 변경** (프론트엔드 수정 필요)
   - 완화: 호환성 테스트, 마이그레이션 가이드
3. **관리자 혼란** (UI 변경)
   - 완화: 명확한 리다이렉트, 교육 실시

### 🎯 성공 기준 (Success Criteria)
- Phase 1: 예약 성공률 > 99%, 충돌 0건 (7일)
- Phase 2: 관리자 업무 중단 0건
- Phase 3: 문서화 완료, 테이블 보존 확인

### 📅 Critical Dates
- **11/12 (화) 08:00**: Phase 1 Production 배포
- **11/15 (금)**: Phase 1 완료 평가 (Go/No-go)
- **11/19 (화)**: Phase 2 실행 (Admin UI)
- **11/27 (수)**: Phase 3 실행 (데이터 정리)

---

**작성**: Claude (System Transition Analysis)
**날짜**: 2025-11-05
**버전**: 1.0
**상태**: ✅ 실행 준비 완료

**다음 단계**: 이해관계자 리뷰 → 11/06 승인 회의 → Phase 1 준비
